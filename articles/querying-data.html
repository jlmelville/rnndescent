<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rnndescent">
<title>Querying Data • rnndescent</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Querying Data">
<meta property="og:description" content="rnndescent">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rnndescent</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.16</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/rnndescent.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/brute-force.html">Brute Force Search</a>
    <a class="dropdown-item" href="../articles/nearest-neighbor-descent.html">Nearest Neighbor Descent</a>
    <a class="dropdown-item" href="../articles/random-partition-forests.html">Random Partition Forests</a>
    <a class="dropdown-item" href="../articles/querying-data.html">Querying Data</a>
    <a class="dropdown-item" href="../articles/hubness.html">Hubness</a>
    <a class="dropdown-item" href="../articles/metrics.html">Metrics</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Querying Data</h1>
            
      
      
      <div class="d-none name"><code>querying-data.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jlmelville.github.io/rnndescent/">rnndescent</a></span><span class="op">)</span></span></code></pre></div>
<p>The usual pattern of usage for approximate nearest neighbors methods
is:</p>
<ol style="list-style-type: decimal">
<li>Build some kind of index with input data.</li>
<li>Query that index with new data to find the nearest neighbors of your
query.</li>
</ol>
<p>This is how e.g. <a href="https://github.com/spotify/annoy" class="external-link">Annoy</a>
and <a href="https://github.com/nmslib/hnswlib" class="external-link">hnswlib</a> work. If you
want just the k-nearest neighbors of the data you used to build the
index in step 1, then you can just pass that data as the query in step
2, but <code>rnndescent</code> provides some specialized functions for
this case that are slightly more efficient, see for example
<code>nnd_knn</code> and <code>rpf_knn</code>. Nonetheless, querying the
index with the original data can produce a more accurate result. See the
<a href="hubness.Rmd">hubness</a> vignette for an example of that.</p>
<p>Below we will see some of the options that <code>rnndescent</code>
has for querying an index.</p>
<p>For convenience, I will use all the even rows of the
<code>iris</code> data to build an index, and search using the odd
rows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_even</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">2</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span></span>
<span><span class="va">iris_odd</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">2</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span></span></code></pre></div>
<div class="section level2">
<h2 id="brute-force">Brute Force<a class="anchor" aria-label="anchor" href="#brute-force"></a>
</h2>
<p>If your dataset is small enough, you can just use brute force to find
the neighbors. No index to build, no worry about how approximate the
results are:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">brute_nbrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brute_force_knn_query.html">brute_force_knn_query</a></span><span class="op">(</span></span>
<span>  query <span class="op">=</span> <span class="va">iris_odd</span>,</span>
<span>  reference <span class="op">=</span> <span class="va">iris_even</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">15</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The format of <code>brute_nbrs</code> is the usual k-nearest
neighbors graph format, a list of two matrices, both of dimension
<code>(nrow(iris_odd), k)</code>. The first matrix, <code>idx</code>
contains the indices of the nearest neighbors, and the second matrix,
<code>dist</code> contains the distances to those neighbors (here I’ll
just show the first five results per row):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">brute_nbrs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">m</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; $idx</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5]</span></span>
<span><span class="co">#&gt; [1,]    9   20   14    4   25</span></span>
<span><span class="co">#&gt; [2,]   24    2   23   15    1</span></span>
<span><span class="co">#&gt; [3,]   19    9    4   20   14</span></span>
<span><span class="co">#&gt; [4,]   24    6   15    2   19</span></span>
<span><span class="co">#&gt; [5,]    2    7   24   23   15</span></span>
<span><span class="co">#&gt; [6,]   14   10    3   16   11</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $dist</span></span>
<span><span class="co">#&gt;           [,1]      [,2]      [,3]      [,4]      [,5]</span></span>
<span><span class="co">#&gt; [1,] 0.1000000 0.1414213 0.1414213 0.1732050 0.2236068</span></span>
<span><span class="co">#&gt; [2,] 0.1414213 0.2449490 0.2645753 0.3000001 0.3000002</span></span>
<span><span class="co">#&gt; [3,] 0.1414213 0.1732050 0.2236066 0.2449488 0.2449488</span></span>
<span><span class="co">#&gt; [4,] 0.2236068 0.3000002 0.3162278 0.3316627 0.4123106</span></span>
<span><span class="co">#&gt; [5,] 0.2999998 0.3464101 0.3605550 0.4242641 0.4690414</span></span>
<span><span class="co">#&gt; [6,] 0.2828429 0.3316626 0.3464102 0.3605551 0.3605553</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="random-projection-forests">Random Projection Forests<a class="anchor" aria-label="anchor" href="#random-projection-forests"></a>
</h2>
<p>If you build a random projection forest with <code>rpf_build</code>,
you can query it with <code>rpf_knn_query</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rpf_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rpf_build.html">rpf_build</a></span><span class="op">(</span><span class="va">iris_even</span><span class="op">)</span></span>
<span><span class="va">rpf_nbrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rpf_knn_query.html">rpf_knn_query</a></span><span class="op">(</span></span>
<span>  query <span class="op">=</span> <span class="va">iris_odd</span>,</span>
<span>  reference <span class="op">=</span> <span class="va">iris_even</span>,</span>
<span>  forest <span class="op">=</span> <span class="va">rpf_index</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">15</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>See the <a href="random-partition-forests.html">Random Partition
Forests vignette</a> for more.</p>
</div>
<div class="section level2">
<h2 id="graph-search">Graph Search<a class="anchor" aria-label="anchor" href="#graph-search"></a>
</h2>
<p>See <span class="citation">(Dobson et al. 2023)</span> for an
overview of graph search algorithms, which can be described as a greedy
beam search over a graph: to find the nearest neighbors, you start at a
candidate in the graph, find the distance from that candidate to the
query point, and update the neighbor list of your query accordingly. If
the candidate made it into the neighbor list of the query, this seems
like a promising direction to go in, so add the candidate’s neighbors to
the list of candidates to explore. Repeat this until such a time as you
run out of candidates. You may want to explore the neighbors of the
candidate even if it doesn’t make it onto the current neighbor list, if
its distance is sufficiently small. How much tolerance you have for this
controls how much back-tracking you do and hence how much exploration
and the amount of time you spend in the search.</p>
<p><code>graph_knn_query</code> implements this search. At the very
least you must provide a <code>reference_graph</code> to search, the
<code>reference</code> data that built the <code>reference_graph</code>
(so we can calculate distances), <code>k</code> the number of neighbors
you want, and of course the <code>query</code> data:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_nbrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_knn_query.html">graph_knn_query</a></span><span class="op">(</span></span>
<span>  query <span class="op">=</span> <span class="va">iris_odd</span>,</span>
<span>  reference <span class="op">=</span> <span class="va">iris_even</span>,</span>
<span>  reference_graph <span class="op">=</span> <span class="va">rpf_nbrs</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">15</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If you aren’t using the <code>metric = "euclidean"</code>, you should
also provide the same <code>metric</code> that you used to build the
<code>reference_graph</code>. The default <code>metric</code> is always
<code>"euclidean"</code> for any function in <code>rnndescent</code> so
it’s not provided in the examples here.</p>
<p>There are some other parameters you will want to tweak in any real
world case that merit some deeper discussion.</p>
<div class="section level3">
<h3 id="n_threads">
<code>n_threads</code><a class="anchor" aria-label="anchor" href="#n_threads"></a>
</h3>
<p><code>n_threads</code> controls how many threads to use in the
search. Be aware that <code>graph_knn_query</code> is designed for
<em>batch</em> parallelism, and each thread will be responsible for
searching a subset of the <code>query</code> points. This means that in
a streaming context, where queries to search are likely to arrive one at
a time, you won’t get any speed up from using multiple threads.</p>
</div>
<div class="section level3">
<h3 id="epsilon">
<code>epsilon</code><a class="anchor" aria-label="anchor" href="#epsilon"></a>
</h3>
<p><code>epsilon</code> controls how much exploration of the neighbors
of a candidate to do. The default value is <code>0.1</code>. The larger
the value, the more back-tracking is permitted. The exact meaning of the
value is related to how large a distance is considered “close enough”
the current neighbor list of the query to be worth exploring.</p>
<p><code>epsilon = 0.1</code> means that the query-candidate distance is
allowed to be 10% larger than the largest distance in the neighbor list.
If you set <code>epsilon = 0.2</code>, for example, then the
query-candidate distance is allowed to be 20% higher than the largest
distance in the neighbor list and so on. If you set
<code>epsilon = 0</code> then you get a pure greedy search.</p>
<p>It’s hard to give a general rule for what value to set, because it’s
highly dependent on the distribution of distances in the dataset and
that is determined by the distance metric and the dimensionality of the
data itself. I recommend leaving this as the default, and only modifying
it if you find that the search is unreasonably slow (in which case make
<code>epsilon</code> smaller) or unreasonably inaccurate (in which case
make <code>epsilon</code> larger). Yes, not very helpful I know.</p>
</div>
<div class="section level3">
<h3 id="init">
<code>init</code><a class="anchor" aria-label="anchor" href="#init"></a>
</h3>
<p>This controls how the search is initialized. If you don’t provide
this, then <code>k</code> random neighbors per item in
<code>query</code> will be generated for you.</p>
<div class="section level4">
<h4 id="neighbor-graph-input">Neighbor Graph Input<a class="anchor" aria-label="anchor" href="#neighbor-graph-input"></a>
</h4>
<p>You may provide your own input for this. It should be in the neighbor
graph format, i.e. a list of two matrices, <code>idx</code> and
<code>dist</code>, as described above. Make sure that the
<code>dist</code> matrix contains the distances using the same
<code>metric</code> you will use in the search.</p>
</div>
<div class="section level4">
<h4 id="neighbor-indices-only">Neighbor Indices Only<a class="anchor" aria-label="anchor" href="#neighbor-indices-only"></a>
</h4>
<p>In fact, the <code>dist</code> matrix is optional. If you only
provide the <code>idx</code> matrix, then the <code>dist</code> matrix
will be calculated for you. If the <code>dist</code> matrix is already
available to you and it was generated by <code>rnndescent</code> then
there is no reason <em>not</em> to use it, but you could have neighbors
that come from:</p>
<ul>
<li>another nearest neighbor package and for some reason you don’t have
the distance</li>
<li>or you have indices from a different metric that you nonetheless
believe are a good guess for the “real” metric.</li>
</ul>
<p>A case where this might be worth experimenting with could be if you
can cheaply binarize your input data, i.e. convert it to 0/1 then to
<code>FALSE</code>/<code>TRUE</code>: you could then use the
<code>hamming</code> metric or another binary-specialized metric on that
input data. Even a brute force search can be very fast on this data.
This could be a good way to get a good guess for the real data.</p>
<p>This is a very contrived example with <code>iris</code>, but let’s do
it anyway:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">numeric_iris</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">is.numeric</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">logical_iris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span><span class="va">numeric_iris</span>, <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">numeric_iris</span><span class="op">)</span>, <span class="st">"&gt;"</span><span class="op">)</span></span>
<span><span class="va">logical_iris_even</span> <span class="op">&lt;-</span> <span class="va">logical_iris</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">logical_iris</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">2</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span></span>
<span><span class="va">logical_iris_odd</span> <span class="op">&lt;-</span> <span class="va">logical_iris</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">logical_iris</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">2</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">logical_iris_even</span><span class="op">)</span></span>
<span><span class="co">#&gt;      Sepal.Length Sepal.Width Petal.Length Petal.Width</span></span>
<span><span class="co">#&gt; [1,]        FALSE       FALSE        FALSE       FALSE</span></span>
<span><span class="co">#&gt; [2,]        FALSE        TRUE        FALSE       FALSE</span></span>
<span><span class="co">#&gt; [3,]        FALSE        TRUE        FALSE       FALSE</span></span>
<span><span class="co">#&gt; [4,]        FALSE        TRUE        FALSE       FALSE</span></span>
<span><span class="co">#&gt; [5,]        FALSE        TRUE        FALSE       FALSE</span></span>
<span><span class="co">#&gt; [6,]        FALSE        TRUE        FALSE       FALSE</span></span></code></pre></div>
<p>Do a brute force search on the binarized data:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_logical_brute_nbrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brute_force_knn_query.html">brute_force_knn_query</a></span><span class="op">(</span></span>
<span>  query <span class="op">=</span> <span class="va">logical_iris_odd</span>,</span>
<span>  reference <span class="op">=</span> <span class="va">logical_iris_even</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">15</span>,</span>
<span>  metric <span class="op">=</span> <span class="st">"hamming"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Then pass the indices of the brute force search to
<code>graph_knn_query</code>, which will generate the Euclidean
distances for you:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">graph_nbrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_knn_query.html">graph_knn_query</a></span><span class="op">(</span></span>
<span>  query <span class="op">=</span> <span class="va">iris_odd</span>,</span>
<span>  reference <span class="op">=</span> <span class="va">iris_even</span>,</span>
<span>  reference_graph <span class="op">=</span> <span class="va">rpf_nbrs</span>,</span>
<span>  init <span class="op">=</span> <span class="va">iris_logical_brute_nbrs</span><span class="op">$</span><span class="va">idx</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">15</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Whether this is worth doing all depends on whether the time taken to
binarize the data followed by the initial search on the binary data (it
doesn’t have to be brute force) gives you a good enough guess to save
time in the “real” search with <code>graph_knn_query</code>.</p>
</div>
<div class="section level4">
<h4 id="forest-initialization">Forest initialization<a class="anchor" aria-label="anchor" href="#forest-initialization"></a>
</h4>
<p>If you have previously built an RP Forest with the data you may also
use that to initialize the query. We can re-use <code>rpf_index</code>
here.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forest_init_nbrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_knn_query.html">graph_knn_query</a></span><span class="op">(</span></span>
<span>  query <span class="op">=</span> <span class="va">iris_odd</span>,</span>
<span>  reference <span class="op">=</span> <span class="va">iris_even</span>,</span>
<span>  reference_graph <span class="op">=</span> <span class="va">rpf_nbrs</span>,</span>
<span>  init <span class="op">=</span> <span class="va">rpf_index</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">15</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In general, the RP forest initialization is likely to be a better
initial guess than random, but in terms of a speed/accuracy trade-off,
using a large forest may not be the best choice. You may want to use
<code>rpf_filter</code> to reduce the size of the forest before using it
as an initial guess. In the <a href="https://github.com/lmcinnes/pynndescent" class="external-link">PyNNDescent</a> Python
package that <code>rnndescent</code> is based on, only one tree is used
for initializing query results.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="preparing-the-search-graph">Preparing the Search Graph<a class="anchor" aria-label="anchor" href="#preparing-the-search-graph"></a>
</h2>
<p>In all the examples so far, we have used the k-nearest neighbors
graph as the <code>reference_graph</code> input to
<code>graph_knn_query</code>. Is this actually a good idea? Probably
not! There is no guarantee that all the items in the original dataset
can actually be reached via the k-nearest neighbors graph. Some nodes
just aren’t very popular and may not be in the neighbor list of
<em>any</em> other item. That means you can never reach them via the
k-nearest neighbors graph, no matter how thoroughly you search it.</p>
<p>We can solve this problem by reversing all the edges in the graph and
adding them to the graph. So if you can get to item <code>i</code> from
item <code>j</code>, you can now get to item <code>j</code> from item
<code>i</code>. This solves one problem but adds some more which is that
just like some items are very unpopular, other items might be very
popular and appear often in the neighbor list of other items. Having a
large number of these edges in the graph can make the search very slow.
We therefore need to prune some of these edges.</p>
<p><code>prepare_search_graph</code> is a function that will take a
k-nearest neighbor graph and add edges to it to make it more useful for
a search. The procedure is based on the process described in <span class="citation">(Harwood and Drummond 2016)</span> and consists of:</p>
<ol style="list-style-type: decimal">
<li>Reversing all the edges in the graph.</li>
<li>“Diversifying” the graph by “occlusion pruning”. This considers
triplets of points, and removes long edges which are probably redundant.
For an item <span class="math inline">\(i\)</span> with neighbors <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> if the distances <span class="math inline">\(d_{pq} \lt d_{ip}\)</span> i.e. the neighbors are
closer to each other than they are to <span class="math inline">\(i\)</span>, then it is said that <span class="math inline">\(p\)</span> occludes <span class="math inline">\(q\)</span> and we don’t need both edges <span class="math inline">\(i \rightarrow p\)</span> and <span class="math inline">\(i \rightarrow q\)</span> – it’s likely that <span class="math inline">\(q\)</span> is in the neighbor list of <span class="math inline">\(p\)</span> or vice versa, so it’s unlikely that we
are doing any harm by getting rid of <span class="math inline">\(i
\rightarrow p\)</span>.</li>
<li>After occlusion pruning, if any item still has an excessive number
of edges, the longest edges are removed until the number of edges is
below the threshold.</li>
</ol>
<p>To control all this pruning the following parameters are
available:</p>
<ul>
<li>
<code>diversify_prob</code>: the probability of a neighbor being
removed if it is found to be an “occlusion”. This should take a value
between <code>0</code> (no diversification) and <code>1</code> (remove
as many edges as possible). The default is <code>1.0</code>.</li>
<li>
<code>pruning_degree_multiplier</code>: controls how many edges to
remove after the occlusion pruning relative to the number of neighbors
in the original nearest neighbor graph. The default is <code>1.5</code>
which means to allow as many as 50% more edge than the original graph.
So if the input graph was for <code>k = 15</code>, each item in the
search graph will have at most <code>15 * 1.5 = 22</code> edges.</li>
</ul>
<p>Let’s see how this works on the <code>iris</code> neighbors:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">iris_search_graph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_search_graph.html">prepare_search_graph</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">iris_even</span>,</span>
<span>  graph <span class="op">=</span> <span class="va">rpf_nbrs</span>,</span>
<span>  diversify_prob <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  pruning_degree_multiplier <span class="op">=</span> <span class="fl">1.5</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Because the returned search graph can contain different number of
edges per item, the neighbor graph format isn’t suitable. Instead you
get back a sparse matrix, specifically a <code>dgCMatrix</code>. Here’s
a histogram of how the edges are distributed:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">search_graph_edges</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">iris_search_graph</span><span class="op">@</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">search_graph_edges</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Distribution of search graph edges"</span>, xlab <span class="op">=</span> <span class="st">"# edges"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="querying-data_files/figure-html/iris%20search%20graph%20histogram-1.png" width="700"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">search_graph_edges</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  8 22</span></span></code></pre></div>
<p>So most items have around about <code>k = 15</code> edges just like
the nearest neighbor graph. But some have have the maximum number of
edges and few have only 10 edges.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">search_nbrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_knn_query.html">graph_knn_query</a></span><span class="op">(</span></span>
<span>  query <span class="op">=</span> <span class="va">iris_odd</span>,</span>
<span>  reference <span class="op">=</span> <span class="va">iris_even</span>,</span>
<span>  reference_graph <span class="op">=</span> <span class="va">iris_search_graph</span>,</span>
<span>  init <span class="op">=</span> <span class="va">rpf_index</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">15</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-dobson2023scaling" class="csl-entry">
Dobson, Magdalen, Zheqi Shen, Guy E Blelloch, Laxman Dhulipala, Yan Gu,
Harsha Vardhan Simhadri, and Yihan Sun. 2023. <span>“Scaling Graph-Based
ANNS Algorithms to Billion-Size Datasets: A Comparative
Analysis.”</span> <em>arXiv Preprint arXiv:2305.04359</em>.
</div>
<div id="ref-harwood2016fanng" class="csl-entry">
Harwood, Ben, and Tom Drummond. 2016. <span>“Fanng: Fast Approximate
Nearest Neighbour Graphs.”</span> In <em>Proceedings of the IEEE
Conference on Computer Vision and Pattern Recognition</em>, 5713–22.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by James Melville.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
