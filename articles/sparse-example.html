<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rnndescent">
<title>Sparse TF-IDF Example • rnndescent</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Sparse TF-IDF Example">
<meta property="og:description" content="rnndescent">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rnndescent</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.16</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/rnndescent.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/brute-force.html">Brute Force Search</a>
    <a class="dropdown-item" href="../articles/nearest-neighbor-descent.html">Nearest Neighbor Descent</a>
    <a class="dropdown-item" href="../articles/random-partition-forests.html">Random Partition Forests</a>
    <a class="dropdown-item" href="../articles/querying-data.html">Querying Data</a>
    <a class="dropdown-item" href="../articles/hubness.html">Hubness</a>
    <a class="dropdown-item" href="../articles/metrics.html">Metrics</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jlmelville/rnndescent/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Sparse TF-IDF Example</h1>
            <h3 data-toc-skip class="subtitle">Text analysis of Jane
Austen</h3>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jlmelville/rnndescent/blob/HEAD/vignettes/articles/sparse-example.Rmd" class="external-link"><code>vignettes/articles/sparse-example.Rmd</code></a></small>
      <div class="d-none name"><code>sparse-example.Rmd</code></div>
    </div>

    
    
<p>It is a truth universally acknowledged than an article author in
possession of a Jane Austen dataset must be in want of a k-nearest
neighbor graph.</p>
<p>In searching for a good example of working with sparse data, text
analysis is a good fit. Using <a href="https://en.wikipedia.org/wiki/Tf%E2%80%93idf" class="external-link">TF-IDF</a> on a
corpus of text documents naturally creates long sparse vectors. We shall
use <a href="https://cran.r-project.org/package=janeaustenr" class="external-link">janeaustenr</a>
which you can see used for TF-IDF in this <a href="https://cran.r-project.org/web/packages/tidytext/vignettes/tf_idf.html" class="external-link">tidytext
vignette</a>. However due to my lack of experience with tidy data
principles, I will be using <a href="https://cran.r-project.org/package=tm" class="external-link">tm</a> and <a href="https://cran.r-project.org/package=slam" class="external-link">slam</a> to create the
TF-IDF matrix.</p>
<p>This article was inspired by a <a href="https://umap-learn.readthedocs.io/en/latest/sparse.html#a-text-analysis-example" class="external-link">similar
example in Python</a>.</p>
<div class="section level2">
<h2 id="this-is-not-a-vignette">This is not a Vignette<a class="anchor" aria-label="anchor" href="#this-is-not-a-vignette"></a>
</h2>
<p>As we need to install and load a lot of packages this is <em>not</em>
a vignette and I won’t show all the output unless it’s interesting or
relevant to the task at hand, but you should get similar results if you
install the packages and run all the code.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>Let’s install some packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"tm"</span>,</span>
<span>  <span class="st">"slam"</span>,</span>
<span>  <span class="st">"janeaustenr"</span>,</span>
<span>  <span class="st">"dplyr"</span>,</span>
<span>  <span class="st">"uwot"</span>,</span>
<span>  <span class="st">"Matrix"</span>,</span>
<span>  <span class="st">"RSpectra"</span>,</span>
<span>  <span class="st">"RColorBrewer"</span>,</span>
<span>  <span class="st">"ggplot2"</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>And then load them:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tm.r-forge.r-project.org/" class="external-link">tm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">slam</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/juliasilge/janeaustenr" class="external-link">janeaustenr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jlmelville.github.io/rnndescent/">rnndescent</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jlmelville/uwot" class="external-link">uwot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/yixuan/RSpectra" class="external-link">RSpectra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="preprocessing-the-text-data">Preprocessing the Text Data<a class="anchor" aria-label="anchor" href="#preprocessing-the-text-data"></a>
</h2>
<p>Let’s start by getting the data. The <code>austen_books()</code>
function returns a tibble with the text of all of Jane Austen’s six
novels, with about 70 characters worth of text per row.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">austen_books</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] 73422     2</code></pre>
<p>There is a <code>book</code> factor column that tells us what book
each line of text is from and then the <code>text</code> contains the
text itself.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code># A tibble: 10 × 2
   text                    book               
   &lt;chr&gt;                   &lt;fct&gt;              
 1 "SENSE AND SENSIBILITY" Sense &amp; Sensibility
 2 ""                      Sense &amp; Sensibility
 3 "by Jane Austen"        Sense &amp; Sensibility
 4 ""                      Sense &amp; Sensibility
 5 "(1811)"                Sense &amp; Sensibility
 6 ""                      Sense &amp; Sensibility
 7 ""                      Sense &amp; Sensibility
 8 ""                      Sense &amp; Sensibility
 9 ""                      Sense &amp; Sensibility
10 "CHAPTER 1"             Sense &amp; Sensibility</code></pre>
<p>Ok, that’s not a lot of text in those rows and a lot of pre-amble.
Let’s take a look at the end (spoiler alerts for the end of
Persuasion):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code># A tibble: 10 × 2
   text                                                                      book      
   &lt;chr&gt;                                                                     &lt;fct&gt;     
 1 "affection.  His profession was all that could ever make her friends"     Persuasion
 2 "wish that tenderness less, the dread of a future war all that could dim" Persuasion
 3 "her sunshine.  She gloried in being a sailor's wife, but she must pay"   Persuasion
 4 "the tax of quick alarm for belonging to that profession which is, if"    Persuasion
 5 "possible, more distinguished in its domestic virtues than in its"        Persuasion
 6 "national importance."                                                    Persuasion
 7 ""                                                                        Persuasion
 8 ""                                                                        Persuasion
 9 ""                                                                        Persuasion
10 "Finis"                                                                   Persuasion</code></pre>
<p>Alright, so we can expect a lot of blank rows. I’d like a bit more
text per entry (and also this reduces the number of rows we need to
process during neighbor search). Let’s group the rows into chunks of 10
and then collapse them. If you want to experiment with this, then you
can change the <code>n_chunks</code> value below.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_chunks</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">data_processed</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">`book`</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>`row_group` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_chunks</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">`book`</span>, <span class="va">`row_group`</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">`text`</span>, collapse <span class="op">=</span> <span class="st">" "</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">data_processed</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] 7344    3</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_processed</span><span class="op">)</span></span></code></pre></div>
<pre><code># A tibble: 6 × 3
  book                row_group text                                                                                                                              
  &lt;fct&gt;                   &lt;dbl&gt; &lt;chr&gt;                                                                                                                             
1 Sense &amp; Sensibility         1 "SENSE AND SENSIBILITY  by Jane Austen  (1811)     CHAPTER 1"                                                                     
2 Sense &amp; Sensibility         2 "  The family of Dashwood had long been settled in Sussex.  Their estate was large, and their residence was at Norland Park, in t…
3 Sense &amp; Sensibility         3 "alteration in his home; for to supply her loss, he invited and received into his house the family of his nephew Mr. Henry Dashwo…
4 Sense &amp; Sensibility         4 " By a former marriage, Mr. Henry Dashwood had one son: by his present lady, three daughters.  The son, a steady respectable youn…
5 Sense &amp; Sensibility         5 "father only seven thousand pounds in his own disposal; for the remaining moiety of his first wife's fortune was also secured to …
6 Sense &amp; Sensibility         6 "son's son, a child of four years old, it was secured, in such a way, as to leave to himself no power of providing for those who …</code></pre>
</div>
<div class="section level2">
<h2 id="text-analysis">Text Analysis<a class="anchor" aria-label="anchor" href="#text-analysis"></a>
</h2>
<p>Next, we must make some decisions about the text pre-processing. You
shouldn’t take any of my decisions as some gold standard of how to do
text processing. The good news is that you can experiment with different
approaches and visualizing the results with UMAP should provide some
feedback.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">corpus</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">Corpus</span><span class="op">(</span><span class="fu">VectorSource</span><span class="op">(</span><span class="va">data_processed</span><span class="op">$</span><span class="va">text</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tm_map</span><span class="op">(</span><span class="fu">content_transformer</span><span class="op">(</span><span class="va">tolower</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tm_map</span><span class="op">(</span><span class="va">removePunctuation</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tm_map</span><span class="op">(</span><span class="va">removeNumbers</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tm_map</span><span class="op">(</span><span class="va">removeWords</span>, <span class="fu">stopwords</span><span class="op">(</span><span class="st">"english"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tm_map</span><span class="op">(</span><span class="va">stripWhitespace</span><span class="op">)</span></span></code></pre></div>
<p>Now we can create the TF-IDF matrix:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tfidf</span> <span class="op">&lt;-</span> <span class="fu">weightTfIdf</span><span class="op">(</span><span class="fu">DocumentTermMatrix</span><span class="op">(</span><span class="va">corpus</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">tfidf</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1]  7344 18853</code></pre>
<p>So nearly 20,000 columns. That’s a lot of dimensions. For a lot of
downstream analysis with dimensionality reduction a typical workflow
would involve:</p>
<ul>
<li>Potentially converting this to a dense representation. As we only
have 7,000 rows this is not a huge memory burden. But if you decided to
use the original data, you would now have a matrix 10 times the
size.</li>
<li>Do some linear dimensionality reduction to a more dense
representation, e.g. Truncated SVD to a few hundred (at most)
dimensions. Or maybe a random projection? In a lot of these cases, there
are ways to do this with the sparse input so you wouldn’t necessarily
need to densify the initial matrix.</li>
</ul>
<p>Nonetheless, this involves making a decision about the number of
dimensions to keep, you need to track what sort of information loss is
involved with that decision, spend the time to do the dimensionality
reduction, and then it’s more data to keep track of. This is where
<code>rnndescent</code> helps by being able to generate the neighbor
graph from the sparse representation directly.</p>
</div>
<div class="section level2">
<h2 id="some-more-preprocessing">Some More Preprocessing<a class="anchor" aria-label="anchor" href="#some-more-preprocessing"></a>
</h2>
<p>Just before we go only further, <code>rnndescent</code> only works
with <code>dgCMatrix</code> so we need to convert the tf-idf matrix:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tfidf_sp</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/sparseMatrix.html" class="external-link">sparseMatrix</a></span><span class="op">(</span></span>
<span>    i <span class="op">=</span> <span class="va">tfidf</span><span class="op">$</span><span class="va">i</span>,</span>
<span>    j <span class="op">=</span> <span class="va">tfidf</span><span class="op">$</span><span class="va">j</span>,</span>
<span>    x <span class="op">=</span> <span class="va">tfidf</span><span class="op">$</span><span class="va">v</span>,</span>
<span>    dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">tfidf</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>And we should normalize the rows. Sadly, <code>apply</code> doesn’t
work well with sparse matrices, so we have to be a bit more creative. An
L2 normalization looks like:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tfidf_spl2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Diagonal.html" class="external-link">Diagonal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">tfidf_sp</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">tfidf_sp</span></span></code></pre></div>
<p>I’m going to use a divergence-based distance metric which assumes
that each row is a probability distribution so I will do an L1
normalization which requires even more creativity. <a href="https://gist.github.com/privefl/1895694804bf9c91a28dd85d3ebf953d" class="external-link">This
gist by privefl</a> was my guide here:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l1_normalize</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">dgt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">X</span>, <span class="st">"TsparseMatrix"</span><span class="op">)</span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">dgt</span><span class="op">@</span><span class="va">x</span>, <span class="va">dgt</span><span class="op">@</span><span class="va">i</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">res</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tmp</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Diagonal.html" class="external-link">Diagonal</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">res</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">X</span></span>
<span><span class="op">}</span></span>
<span><span class="va">tfidf_spl1</span> <span class="op">&lt;-</span> <span class="fu">l1_normalize</span><span class="op">(</span><span class="va">tfidf_sp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">tfidf_spl1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] 1 1 1 1 1 1</code></pre>
</div>
<div class="section level2">
<h2 id="nearest-neighbor-search">Nearest Neighbor Search<a class="anchor" aria-label="anchor" href="#nearest-neighbor-search"></a>
</h2>
<p>With only 7000 rows, we can do a brute force search and get the exact
nearest neighbors.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tfidfl1_js_bf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/brute_force_knn.html">brute_force_knn</a></span><span class="op">(</span></span>
<span>    <span class="va">tfidf_spl1</span>,</span>
<span>    k <span class="op">=</span> <span class="fl">15</span>,</span>
<span>    metric <span class="op">=</span> <span class="st">"jensenshannon"</span>,</span>
<span>    n_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code>10:19:28 Calculating brute force k-nearest neighbors with k = 15 using 6 threads
0%   10   20   30   40   50   60   70   80   90   100%
[----|----|----|----|----|----|----|----|----|----]
***************************************************
10:20:52 Finished</code></pre>
<p>This only takes just over a minute with 6 threads on my 8th-gen Intel
i7 laptop which is no longer cutting-edge.</p>
</div>
<div class="section level2">
<h2 id="hubness">Hubness<a class="anchor" aria-label="anchor" href="#hubness"></a>
</h2>
<p>I always strongly recommend looking at the distribution of the edges
throughout the graph, and specifically looking at the hubness. First
generate the k-occurrences:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">k_occurrences</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/k_occur.html">k_occur</a></span><span class="op">(</span><span class="va">tfidfl1_js_bf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">k_occurrences</span><span class="op">)</span></span></code></pre></div>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      1       6      11      15      19     167 </code></pre>
<p>This is telling us about the popularity of items in the dataset,
i.e. while every item has 15 neighbors, which items tend to show up in
the neighbor list of items more than average? If an item has a
k-occurrence higher than 15 then it’s more popular than average, and
vice versa. An item with a k-occurrence of 1 is called an anti-hub, and
is an item that is never a neighbor of any other item (the one edge it
has is to itself). Conversely, we can see that some items are
<em>very</em> popular, with a k-occurrence more than ten times higher
than average. These could definitely be considered hubs.</p>
<p>Here’s the k-occurrences of the top 6 most popular items:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">k_occurrences</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] 129 137 138 152 158 167</code></pre>
<p>And here is how many anti-hubs we have:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">k_occurrences</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] 129</code></pre>
<p>So 129 pieces of text in the corpus are not considered to be in the
top-15 neighbors of any other piece of text. Not quite 2% of the
dataset.</p>
<p>Note that the values you get for hubness are <em>highly</em>
dependent on things like how the dataset is scaled, what distance you
use and obviously the number of neighbors. In this case, we’re doing
pretty ok. Using the Euclidean distance on high-dimensional data tends
to produce very large numbers of hubs, which can really distort the
downstream analysis so it’s important to check this.</p>
</div>
<div class="section level2">
<h2 id="hub-and-hubbability">Hub and Hubbability<a class="anchor" aria-label="anchor" href="#hub-and-hubbability"></a>
</h2>
<p>Perhaps we can learn something about the dataset by taking a closer
look at the hubs and anti-hubs. The hubs represent items which are seen
as similar by lots of other items, so you could imagine that these items
represent the most Jane Austen-like pieces of text in the dataset.
Meanwhile the anti-hubs must be less usual prose in some way. Let’s look
at the popular text first.</p>
<div class="section level3">
<h3 id="popular-text">Popular Text<a class="anchor" aria-label="anchor" href="#popular-text"></a>
</h3>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">popular_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">k_occurrences</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data_processed</span><span class="op">[</span><span class="va">popular_indices</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"book"</span>, <span class="st">"text"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code># A tibble: 6 × 2
  book              text                                                                                          
  &lt;fct&gt;             &lt;chr&gt;                                                                                         
1 Mansfield Park    "You will be what you ought to be to her. I hope it does not distress you very much, Fanny?\"…
2 Emma              "know any body was coming. 'It is only Mrs. Cole,' said I, 'depend upon it. Nobody else would…
3 Pride &amp; Prejudice "Jane? Shall you like to have such a brother?\"  \"Very, very much. Nothing could give either…
4 Emma              " \"Perhaps she might; but it is not every man's fate to marry the woman who loves him best. …
5 Northanger Abbey  " \"Henry!\" she replied with a smile. \"Yes, he does dance very well.\"  \"He must have thou…
6 Pride &amp; Prejudice " \"I wish you joy. If you love Mr. Darcy half as well as I do my dear Wickham, you must be v…</code></pre>
<p>Here’s the full text from the most popular item:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_processed</span><span class="op">[</span><span class="va">popular_indices</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="op">]</span><span class="op">$</span><span class="va">text</span></span></code></pre></div>
<pre><code>[1] "You will be what you ought to be to her. I hope it does not distress you very much, Fanny?\"  \"Indeed it does: I cannot like it. I love this house and everything in it: I shall love nothing there. You know how uncomfortable I feel with her.\"  \"I can say nothing for her manner to you as a child; but it was the same with us all, or nearly so. She never knew how to be pleasant to children. But you are now of an age to be treated better; I think she is"</code></pre>
<p>All dialog and it does contain the word “love” in a lot of them. But
without looking at other text, it’s hard to say if that is a
distinguishing characteristic of this text. So let’s now look at the
unpopular items.</p>
</div>
<div class="section level3">
<h3 id="unpopular-text">Unpopular Text<a class="anchor" aria-label="anchor" href="#unpopular-text"></a>
</h3>
<p>In terms of the anti-hubs, we have a large number of those, so let’s
sample 6 at random:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unpopular_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">k_occurrences</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">data_processed</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">unpopular_indices</span>, <span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"book"</span>, <span class="st">"text"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code># A tibble: 6 × 2
  book                text                                                                                                                                  
  &lt;fct&gt;               &lt;chr&gt;                                                                                                                                 
1 Emma                "a letter, among the thousands that are constantly passing about the kingdom, is even carried wrong--and not one in a million, I supp…
2 Northanger Abbey    "Catherine heard neither the particulars nor the result. Her companion's discourse now sunk from its hitherto animated pitch to nothi…
3 Mansfield Park      "whose distress she thought of most. Julia's elopement could affect her comparatively but little; she was amazed and shocked; but it …
4 Persuasion          "tried, more fixed in a knowledge of each other's character, truth, and attachment; more equal to act, more justified in acting.  And…
5 Sense &amp; Sensibility "but not on picturesque principles.  I do not like crooked, twisted, blasted trees.  I admire them much more if they are tall, straig…
6 Sense &amp; Sensibility "and though a sigh sometimes escaped her, it never passed away without the atonement of a smile.  After dinner she would try her pian…</code></pre>
<p>And here’s the full text of a randomly selected item:</p>
<pre><code><span><span class="va">data_processed</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">unpopular_indices</span>, <span class="fl">1</span><span class="op">)</span>,<span class="op">]</span><span class="op">$</span><span class="va">text</span></span></code></pre>
<pre><code>[1] "unwelcome, most ill-timed, most appalling! Mr. Yates might consider it only as a vexatious interruption for the evening, and Mr. Rushworth might imagine it a blessing; but every other heart was sinking under some degree of self-condemnation or undefined alarm, every other heart was suggesting, \"What will become of us? what is to be done now?\" It was a terrible pause; and terrible to every ear were the corroborating sounds of opening doors and passing footsteps.  Julia was the first to move and speak again. Jealousy and bitterness had been suspended: selfishness was lost in the common cause; but at the"</code></pre>
<p>There’s definitely a different flavor to the text of the anti-hubs we
see here compared to the hubs, but this is only a small fraction of the
anti-hubs. At least it isn’t just pulling out passages from Northanger
Abbey.</p>
</div>
<div class="section level3">
<h3 id="popular-and-unpopular-words">Popular and Unpopular Words<a class="anchor" aria-label="anchor" href="#popular-and-unpopular-words"></a>
</h3>
<p>It’s not entirely obvious what the difference is between the popular
and unpopular texts. Maybe we can look at the average tf-idf value of
the words in the most and least popular texts? To check this makes any
sense at all, let’s just see what the most popular words in Pride &amp;
Prejudice are with this method:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pap</span> <span class="op">&lt;-</span> <span class="va">tfidf_sp</span><span class="op">[</span><span class="va">data_processed</span><span class="op">$</span><span class="va">book</span> <span class="op">==</span> <span class="st">"Pride &amp; Prejudice"</span>, <span class="op">]</span></span>
<span><span class="va">mean_pap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">pap</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mean_pap</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tfidf</span><span class="op">)</span></span>
<span><span class="va">mean_pap</span><span class="op">[</span><span class="va">mean_pap</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span>decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code>elizabeth      darcy     bennet    bingley       jane       will       said    wickham    collins      lydia 
0.04253865 0.03290232 0.02795931 0.02545364 0.01991761 0.01847970 0.01713893 0.01687501 0.01687119 0.01438015 </code></pre>
<p>That actually correponds ok with results from the
<code>tidytext</code> vignette: it’s mainly character names (and, er,
<code>'said'</code>).</p>
<p>If we apply this to the dataset as a whole:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_tfidf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">tfidf_sp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mean_tfidf</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tfidf</span><span class="op">)</span></span>
<span><span class="va">mean_tfidf</span><span class="op">[</span><span class="va">mean_tfidf</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span>decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code>      will        mrs       said       must       miss       much        one      think       know      never 
0.01630534 0.01513324 0.01446493 0.01388111 0.01355313 0.01307697 0.01266730 0.01200490 0.01169455 0.01152472</code></pre>
<p>Now we have more generic words, although <code>said</code> is still
there. Way to go, <code>said</code>.</p>
<p>What do the popular words look like (and is <code>said</code> in
there too?):</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_popular_tfidf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">tfidf_sp</span><span class="op">[</span><span class="va">popular_indices</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mean_popular_tfidf</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tfidf</span><span class="op">)</span></span>
<span><span class="va">mean_popular_tfidf</span><span class="op">[</span><span class="va">mean_popular_tfidf</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span>decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code>      love      quite       well       feel      think       like      shall       sure    nothing        yes 
0.08188918 0.07007464 0.06825873 0.06808318 0.06540969 0.06223084 0.06055058 0.05710714 0.05624428 0.05375587 </code></pre>
<p>There’s <code>love</code> right at the top. No <code>said</code> to
be seen, and not a lot of overlap with the average words.</p>
<p>Onto the unpopular text.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_unpopular_tfidf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">tfidf_sp</span><span class="op">[</span><span class="va">unpopular_indices</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mean_unpopular_tfidf</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tfidf</span><span class="op">)</span></span>
<span><span class="va">mean_unpopular_tfidf</span><span class="op">[</span><span class="va">mean_unpopular_tfidf</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span>decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code>      every        much        mind       might        must     harriet     without         one        long       first 
0.014918830 0.011596126 0.011479893 0.011270905 0.011188771 0.010718795 0.010047623 0.009764715 0.009650010 0.009499682 </code></pre>
<p>There is a bit more overlap with the average words here, but what was
it Tolstoy said about unhappy families? I wouldn’t necessarily expect a
theme to emerge from chunks of text which have nothing in common with
anything else.</p>
<p>So there you have scientific proof that if you want to sound like
Jane Austen, write about “love”. “think” and “feel”. If you
<em>don’t</em> want to sound like classic Jane Austen, sprinkle in an
“every” and a “long”. Also “Harriet”. Good luck.</p>
</div>
</div>
<div class="section level2">
<h2 id="umap">UMAP<a class="anchor" aria-label="anchor" href="#umap"></a>
</h2>
<p>We can also visualize the neighbor graph by carrying out
dimensionality reduction using UMAP via the <code>uwot</code> package.
This will attempt place nearest neighbors close together in a 2D scatter
plot.</p>
<p><code>uwot</code>doesn’t need any more input information than the
k-nearest neighbor graph, which you pass to the <code>nn_method</code>
parameter. This also requires explicitly setting the usual data input
parameter <code>X</code> to <code>NULL</code>. I am also setting the
density scaling to <code>0.5</code>, which attempts to re-add some of
the relative density of any clusters in the data back into the embedding
using the <a href="https://jlmelville.github.io/uwot/leopold.html" class="external-link">LEOPOLD
approximation to densMAP</a>.</p>
<p>UMAP uses a random number generator as part of its contrastive
learning style optimization, but I am purposely <em>not</em> setting a
random seed so that you will get different results from me. This is a
way to avoid over-interpreting the layout of the clusters. I recommend
running the algorithm a few times and seeing what changes.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">js_umap</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">umap</span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    nn_method <span class="op">=</span> <span class="va">tfidfl1_js_bf</span>,</span>
<span>    n_sgd_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    n_epochs <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    batch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    init_sdev <span class="op">=</span> <span class="st">"range"</span>,</span>
<span>    dens_scale <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plot">Plot<a class="anchor" aria-label="anchor" href="#plot"></a>
</h2>
<p>Let’s plot what we got:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">js_umap</span>, Book <span class="op">=</span> <span class="va">data_processed</span><span class="op">$</span><span class="va">book</span><span class="op">)</span>,</span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">X1</span>, y <span class="op">=</span> <span class="va">X2</span>, color <span class="op">=</span> <span class="va">Book</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.6</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Jensen-Shannon Divergence UMAP"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">""</span>,</span>
<span>    y <span class="op">=</span> <span class="st">""</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Book"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="umap-austen.png" alt=""><p class="caption">UMAP plot</p>
</div>
<p>Hey, that looks pretty good! We can see that the texts from each book
are mostly clustered together. The clusters for “Persuasion” and
“Northanger Abbey” are smaller than the other books. In terms of the
relative position of the clusters, you must take care not to
over-interpret this. When I re-run UMAP multiple times the clusters do
move about, but “Pride &amp; Prejudice” and “Sense &amp; Sensibility”
usually end up together.</p>
<div class="section level3">
<h3 id="neighbor-preservation">Neighbor Preservation<a class="anchor" aria-label="anchor" href="#neighbor-preservation"></a>
</h3>
<p>To get a more quantitative sense of how well this reduction has
preserved the high-dimensional structure, we can calculate the nearest
neighbors in the 2D space and compare them to the nearest neighbors in
the high-dimensional space.</p>
<p>With only two dimensions, brute force search is very fast. UMAP uses
the <em>Euclidean</em> distance in the output embedding to match the
similarities in the input space, so we use
<code>metric = "euclidean"</code> rather than
<code>"jensenshannon"</code>:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">umap_nbrs</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/brute_force_knn.html">brute_force_knn</a></span><span class="op">(</span><span class="va">js_umap</span>,</span>
<span>    k <span class="op">=</span> <span class="fl">15</span>,</span>
<span>    n_threads <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    metric <span class="op">=</span> <span class="st">"euclidean"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Now we can measure the overlap between the two neighbor graphs:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/neighbor_overlap.html">neighbor_overlap</a></span><span class="op">(</span><span class="va">umap_nbrs</span>, <span class="va">tfidfl1_js_bf</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="fl">0.1604303</span></span></code></pre>
<p>So on average 16% of the neighbor list was retained after embedding
into 2D. Although this doesn’t sound like much, this actually pretty
standard for UMAP (and maybe a bit better than normal). Your numbers are
going to vary a bit from this, but hopefully not by much.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>Whatever you think of my text analysis skills, the point is that
<code>rnndescent</code> can be used to handle sparse data as easily as
dense data, which makes working with it a lot simpler.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by James Melville.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
