<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Run queries against reference data to return randomly selected neighbors.
This is not a useful query method on its own, but can be used with other
methods which require initialization."><title>Query nearest neighbors by random selection — random_knn_query • rnndescent</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Query nearest neighbors by random selection — random_knn_query"><meta property="og:description" content="Run queries against reference data to return randomly selected neighbors.
This is not a useful query method on its own, but can be used with other
methods which require initialization."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rnndescent</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="../articles/rnndescent.html">Get started</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/brute-force.html">Brute Force Search</a>
    <a class="dropdown-item" href="../articles/nearest-neighbor-descent.html">Nearest Neighbor Descent</a>
    <a class="dropdown-item" href="../articles/random-partition-forests.html">Random Partition Forests</a>
    <a class="dropdown-item" href="../articles/querying-data.html">Querying Data</a>
    <a class="dropdown-item" href="../articles/hubness.html">Hubness</a>
    <a class="dropdown-item" href="../articles/metrics.html">Metrics</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jlmelville/rnndescent/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Query nearest neighbors by random selection</h1>
      <small class="dont-index">Source: <a href="https://github.com/jlmelville/rnndescent/blob/HEAD/R/rnndescent.R" class="external-link"><code>R/rnndescent.R</code></a></small>
      <div class="d-none name"><code>random_knn_query.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Run queries against reference data to return randomly selected neighbors.
This is not a useful query method on its own, but can be used with other
methods which require initialization.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">random_knn_query</span><span class="op">(</span></span>
<span>  <span class="va">query</span>,</span>
<span>  <span class="va">reference</span>,</span>
<span>  <span class="va">k</span>,</span>
<span>  metric <span class="op">=</span> <span class="st">"euclidean"</span>,</span>
<span>  use_alt_metric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  order_by_distance <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  n_threads <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  obs <span class="op">=</span> <span class="st">"R"</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>query</dt>
<dd><p>Matrix of <code>n</code> query items, with observations in the rows and
features in the columns. Optionally, the data may be passed with the
observations in the columns, by setting <code>obs = "C"</code>, which should be more
efficient. The <code>reference</code> data must be passed in the same orientation as
<code>query</code>. Possible formats are <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">base::data.frame()</a></code>, <code><a href="https://rdrr.io/r/base/matrix.html" class="external-link">base::matrix()</a></code>
or <code><a href="https://rdrr.io/pkg/Matrix/man/sparseMatrix.html" class="external-link">Matrix::sparseMatrix()</a></code>. Sparse matrices should be in <code>dgCMatrix</code>
format. Dataframes will be converted to <code>numerical</code> matrix format
internally, so if your data columns are <code>logical</code> and intended to be used
with the specialized binary <code>metric</code>s, you should convert it to a logical
matrix first (otherwise you will get the slower dense numerical version).</p></dd>


<dt>reference</dt>
<dd><p>Matrix of <code>m</code> reference items, with observations in the rows
and features in the columns. The nearest neighbors to the queries are
randomly selected from this data. Optionally, the data may be passed with
the observations in the columns, by setting <code>obs = "C"</code>, which should be
more efficient. The <code>query</code> data must be passed in the same orientation
and format as <code>reference</code>. Possible formats are <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">base::data.frame()</a></code>,
<code><a href="https://rdrr.io/r/base/matrix.html" class="external-link">base::matrix()</a></code> or <code><a href="https://rdrr.io/pkg/Matrix/man/sparseMatrix.html" class="external-link">Matrix::sparseMatrix()</a></code>. Sparse matrices should be in
<code>dgCMatrix</code> format.</p></dd>


<dt>k</dt>
<dd><p>Number of nearest neighbors to return.</p></dd>


<dt>metric</dt>
<dd><p>Type of distance calculation to use. One of:</p><ul><li><p><code>"braycurtis"</code></p></li>
<li><p><code>"canberra"</code></p></li>
<li><p><code>"chebyshev"</code></p></li>
<li><p><code>"correlation"</code> (1 minus the Pearson correlation)</p></li>
<li><p><code>"cosine"</code></p></li>
<li><p><code>"dice"</code></p></li>
<li><p><code>"euclidean"</code></p></li>
<li><p><code>"hamming"</code></p></li>
<li><p><code>"hellinger"</code></p></li>
<li><p><code>"jaccard"</code></p></li>
<li><p><code>"jensenshannon"</code></p></li>
<li><p><code>"kulsinski"</code></p></li>
<li><p><code>"sqeuclidean"</code> (squared Euclidean)</p></li>
<li><p><code>"manhattan"</code></p></li>
<li><p><code>"rogerstanimoto"</code></p></li>
<li><p><code>"russellrao"</code></p></li>
<li><p><code>"sokalmichener"</code></p></li>
<li><p><code>"sokalsneath"</code></p></li>
<li><p><code>"spearmanr"</code> (1 minus the Spearman rank correlation)</p></li>
<li><p><code>"symmetrickl"</code> (symmetric Kullback-Leibler divergence)</p></li>
<li><p><code>"tsss"</code> (Triangle Area Similarity-Sector Area Similarity or TS-SS
metric)</p></li>
<li><p><code>"yule"</code></p></li>
</ul><p>For non-sparse data, the following variants are available with
preprocessing: this trades memory for a potential speed up during the
distance calculation. Some minor numerical differences should be expected
compared to the non-preprocessed versions:</p><ul><li><p><code>"cosine-preprocess"</code>: <code>cosine</code> with preprocessing.</p></li>
<li><p><code>"correlation-preprocess"</code>: <code>correlation</code> with preprocessing.</p></li>
</ul><p>For non-sparse binary data passed as a <code>logical</code> matrix, the following
metrics have specialized variants which should be substantially faster than
the non-binary variants (in other cases the logical data will be treated as
a dense numeric vector of 0s and 1s):</p><ul><li><p><code>"dice"</code></p></li>
<li><p><code>"hamming"</code></p></li>
<li><p><code>"jaccard"</code></p></li>
<li><p><code>"kulsinski"</code></p></li>
<li><p><code>"matching"</code></p></li>
<li><p><code>"rogerstanimoto"</code></p></li>
<li><p><code>"russellrao"</code></p></li>
<li><p><code>"sokalmichener"</code></p></li>
<li><p><code>"sokalsneath"</code></p></li>
<li><p><code>"yule"</code></p></li>
</ul></dd>


<dt>use_alt_metric</dt>
<dd><p>If <code>TRUE</code>, use faster metrics that maintain the
ordering of distances internally (e.g. squared Euclidean distances if using
<code>metric = "euclidean"</code>), then apply a correction at the end. Probably
the only reason to set this to <code>FALSE</code> is if you suspect that some
sort of numeric issue is occurring with your data in the alternative code
path.</p></dd>


<dt>order_by_distance</dt>
<dd><p>If <code>TRUE</code> (the default), then results for each
item are returned by increasing distance. If you don't need the results
sorted, e.g. you are going to pass the results as initialization to another
routine like <code><a href="graph_knn_query.html">graph_knn_query()</a></code>, set this to <code>FALSE</code> to save a
small amount of computational time.</p></dd>


<dt>n_threads</dt>
<dd><p>Number of threads to use.</p></dd>


<dt>verbose</dt>
<dd><p>If <code>TRUE</code>, log information to the console.</p></dd>


<dt>obs</dt>
<dd><p>set to <code>"C"</code> to indicate that the input <code>query</code> and <code>reference</code>
orientation stores each observation as a column (the orientation must be
consistent). The default <code>"R"</code> means that observations are stored in each
row. Storing the data by row is usually more convenient, but internally
your data will be converted to column storage. Passing it already
column-oriented will save some memory and (a small amount of) CPU usage.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>an approximate nearest neighbor graph as a list containing:</p><ul><li><p><code>idx</code> an n by k matrix containing the nearest neighbor indices.</p></li>
<li><p><code>dist</code> an n by k matrix containing the nearest neighbor distances.</p></li>
</ul></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># 100 reference iris items</span></span></span>
<span class="r-in"><span><span class="va">iris_ref</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"setosa"</span>, <span class="st">"versicolor"</span><span class="op">)</span>, <span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># 50 query items</span></span></span>
<span class="r-in"><span><span class="va">iris_query</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"versicolor"</span>, <span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># For each item in iris_query find 4 random neighbors in iris_ref</span></span></span>
<span class="r-in"><span><span class="co"># If you pass a data frame, non-numeric columns are removed</span></span></span>
<span class="r-in"><span><span class="co"># set verbose = TRUE to get details on the progress being made</span></span></span>
<span class="r-in"><span><span class="va">iris_query_random_nbrs</span> <span class="op">&lt;-</span> <span class="fu">random_knn_query</span><span class="op">(</span><span class="va">iris_query</span>,</span></span>
<span class="r-in"><span>  reference <span class="op">=</span> <span class="va">iris_ref</span>,</span></span>
<span class="r-in"><span>  k <span class="op">=</span> <span class="fl">4</span>, metric <span class="op">=</span> <span class="st">"euclidean"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 06:42:11 Using alt metric 'sqeuclidean' for 'euclidean'</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 06:42:11 Generating random k-nearest neighbor graph from reference with k = 4</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 06:42:11 Finished</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Manhattan (l1) distance</span></span></span>
<span class="r-in"><span><span class="va">iris_query_random_nbrs</span> <span class="op">&lt;-</span> <span class="fu">random_knn_query</span><span class="op">(</span><span class="va">iris_query</span>,</span></span>
<span class="r-in"><span>  reference <span class="op">=</span> <span class="va">iris_ref</span>,</span></span>
<span class="r-in"><span>  k <span class="op">=</span> <span class="fl">4</span>, metric <span class="op">=</span> <span class="st">"manhattan"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by James Melville.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

